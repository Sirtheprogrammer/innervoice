rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    // Prefer custom claims: `request.auth.token.admin == true` when available.
    // Fallback: check `users/{uid}.role == 'admin'` document in Firestore.
    function isAdmin() {
      return isAuthenticated() && (
        (request.auth.token.admin == true) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // Helper function to check if user is NOT banned
    function isNotBanned() {
      return !isAuthenticated() || 
             !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.banned != true;
    }

    // Announcements Collection Rules
    match /announcements/{document=**} {
      // Read: Public can read (for carousel on homepage)
      allow read: if true;
      
      // Create: Only authenticated admins can create
      allow create: if isAuthenticated() && 
                       request.resource.data.title != null &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.title.size() <= 100 &&
                       request.resource.data.image != null &&
                       request.resource.data.image is string &&
                       request.resource.data.createdAt != null &&
                       request.resource.data.updatedAt != null;
      
      // Update: Only authenticated admins can update
      allow update: if isAuthenticated() && 
                       request.resource.data.title != null &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.title.size() <= 100 &&
                       request.resource.data.updatedAt != null;
      
      // Delete: Only authenticated admins can delete
      allow delete: if isAuthenticated();
    }

    // Updates Collection Rules (Rich content with tags and social media)
    match /updates/{document=**} {
      // Read: Public can read (for updates section on homepage)
      allow read: if true;
      
      // Create: Only authenticated users can create
      allow create: if isAuthenticated() && 
                       // Title validation
                       request.resource.data.title != null &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.title.size() <= 150 &&
                       // Main content validation
                       request.resource.data.mainContent != null &&
                       request.resource.data.mainContent is string &&
                       request.resource.data.mainContent.size() > 0 &&
                       request.resource.data.mainContent.size() <= 2000 &&
                       // Image validation
                       request.resource.data.image != null &&
                       request.resource.data.image is string &&
                       request.resource.data.image.size() > 0 &&
                       // Tags validation (optional, must be array)
                       request.resource.data.tags is list &&
                       // Social media links validation (optional, must be map)
                       request.resource.data.socialMediaLinks is map &&
                       // Timestamps validation
                       request.resource.data.createdAt != null &&
                       request.resource.data.updatedAt != null &&
                       // User tracking
                       request.resource.data.createdBy != null &&
                       request.resource.data.createdBy is string;
      
      // Update: Only authenticated users can update
      allow update: if isAuthenticated() && 
                       // Title validation
                       request.resource.data.title != null &&
                       request.resource.data.title is string &&
                       request.resource.data.title.size() > 0 &&
                       request.resource.data.title.size() <= 150 &&
                       // Main content validation
                       request.resource.data.mainContent != null &&
                       request.resource.data.mainContent is string &&
                       request.resource.data.mainContent.size() > 0 &&
                       request.resource.data.mainContent.size() <= 2000 &&
                       // Image validation
                       request.resource.data.image != null &&
                       request.resource.data.image is string &&
                       request.resource.data.image.size() > 0 &&
                       // Tags validation (optional, must be array)
                       request.resource.data.tags is list &&
                       // Social media links validation (optional, must be map)
                       request.resource.data.socialMediaLinks is map &&
                       // Timestamps validation
                       request.resource.data.updatedAt != null &&
                       // User tracking
                       request.resource.data.updatedBy != null &&
                       request.resource.data.updatedBy is string;
      
      // Delete: Only authenticated users can delete
      allow delete: if isAuthenticated();
    }

    // Confessions Collection Rules (Authenticated posts)
    match /confessions/{confessionId} {
      // Read: Public can read all confessions
      allow read: if true;
      
      // Create: Authenticated users can create. Must set userId to own uid.
      allow create: if isAuthenticated() && isNotBanned() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.content != null &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 5000 &&
                       request.resource.data.createdAt != null &&
                       request.resource.data.updatedAt != null &&
                       request.resource.data.commentCount == 0 &&
                       request.resource.data.flagCount == 0;
      
      // Update rule handles 3 cases:
      // 1. Counter updates (likes, comments, flags) - allowed for anyone (public/users)
      // 2. Admin moderation - allowed for admins
      // 3. Author edits - allowed for the creator of the confession
      allow update: if 
        // 1. Public/Counter updates (unchanged content)
        (request.resource.data.content == resource.data.content &&
         request.resource.data.title == resource.data.title &&
         request.resource.data.userId == resource.data.userId &&
         request.resource.data.createdAt == resource.data.createdAt &&
         request.resource.data.updatedAt != null &&
         ((request.resource.data.commentCount is number) ||
          (request.resource.data.flagCount is number) ||
          (request.resource.data.likeCount is number))) 
        ||
        // 2. Admin updates
        (isAdmin() && 
         request.resource.data.content == resource.data.content &&
         request.resource.data.createdAt == resource.data.createdAt &&
         (request.resource.data.moderated is bool ||
          request.resource.data.reason is string ||
          request.resource.data.moderatedAt is timestamp))
        ||
        // 3. Author updates (content/title only)
        (isAuthenticated() && isNotBanned() &&
         resource.data.userId == request.auth.uid &&
         request.resource.data.userId == resource.data.userId &&
         request.resource.data.createdAt == resource.data.createdAt &&
         request.resource.data.commentCount == resource.data.commentCount &&
         request.resource.data.flagCount == resource.data.flagCount &&
         request.resource.data.updatedAt != null);
      
      // Delete: Admins or the Author can delete
      allow delete: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
    }

    // Comments Collection Rules (Comments and replies on confessions)
    match /comments/{commentId} {
      // Read: Public can read all comments
      allow read: if true;
      
      // Create: Anyone (no auth required) can create a comment
      allow create: if isNotBanned() &&
                       request.resource.data.confessionId != null &&
                       request.resource.data.confessionId is string &&
                       request.resource.data.content != null &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 2000 &&
                       request.resource.data.createdAt != null &&
                       request.resource.data.updatedAt != null &&
                       request.resource.data.replyCount == 0 &&
                       request.resource.data.flagCount == 0 &&
                       (request.resource.data.parentCommentId == null ||
                        request.resource.data.parentCommentId is string);
      
      // Update: Users can update reply count, admins can also update moderation status
      allow update: if (request.resource.data.content == resource.data.content &&
                        request.resource.data.confessionId == resource.data.confessionId &&
                        request.resource.data.parentCommentId == resource.data.parentCommentId &&
                        request.resource.data.createdAt == resource.data.createdAt &&
                        request.resource.data.updatedAt != null &&
                        ((request.resource.data.replyCount is number) ||
                         (request.resource.data.flagCount is number))) ||
                       (isAdmin() && 
                        request.resource.data.content == resource.data.content &&
                        request.resource.data.confessionId == resource.data.confessionId &&
                        request.resource.data.parentCommentId == resource.data.parentCommentId &&
                        request.resource.data.createdAt == resource.data.createdAt &&
                        request.resource.data.replyCount == resource.data.replyCount &&
                        request.resource.data.flagCount == resource.data.flagCount &&
                        request.resource.data.updatedAt != null &&
                        (request.resource.data.moderated is bool ||
                         request.resource.data.reason is string ||
                         request.resource.data.moderatedAt is timestamp));
      
      // Delete: Only admins can delete (moderation)
      allow delete: if isAdmin();
    }

    // Admins Collection (for tracking admin users)
    match /admins/{userId} {
      // Read: Only the user can read their own admin document
      allow read: if request.auth.uid == userId;
      
      // Create: Only authenticated users can create their admin document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Update: Only the user can update their own document
      allow update: if request.auth.uid == userId;
      
      // Delete: Deny deletion (admins should be managed by super-admin)
      allow delete: if false;
    }

    // Users Collection (profiles and roles)
    match /users/{userId} {
      // Read: user can read their own profile, admins can read any
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());

      // Create: only the authenticated user may create their own profile
      // and clients MUST set role to 'user' (admins must be granted server-side)
      allow create: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.role == 'user'
                    && request.resource.data.email is string
                    && request.resource.data.createdAt != null;

      // Update: user can update their profile but cannot change `role`, admins can update anything
      allow update: if (request.auth != null && request.auth.uid == userId
                    && request.resource.data.role == resource.data.role)
                    || isAdmin();

      // Delete: only admins may delete user docs (managed by super-admin)
      allow delete: if isAdmin();
    }
  }
}
